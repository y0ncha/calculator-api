# Calculator API Development Guide

## Overview

This is a Node.js calculator API built with Express that provides both stack-based and independent arithmetic operations. The API persists all operations to a PostgreSQL database with optional MongoDB support for future extensions. The project uses Prisma ORM for database access and follows a layered architecture with clear separation between routes, controllers, and repositories.

## Architecture & Folder Responsibilities

### Project Structure

```
src/
├── server.js                   # Express app entry point, middleware setup, route registration
├── routes/                     # Route definitions only (no DB logic, no business logic)
│   ├── stack.js               # Stack-based calculator endpoints
│   ├── independent.js         # Independent calculator endpoints
│   └── general.js             # Health, history, DB clear, log level endpoints
├── controllers/               # Request handling, validation, orchestration
│   ├── stack.js              # Stack operations logic + repo calls
│   ├── independent.js        # Independent operations logic + repo calls
│   └── general.js            # General endpoints logic
├── db/                        # Database layer
│   ├── clients/
│   │   └── prisma.js         # Single Prisma client instance (NEVER create PrismaClient elsewhere)
│   └── repositories/
│       └── postgres.js       # DB access: insertOperation, listOperations, clearDatabase
├── utils/                     # Business logic utilities (stack, operations, history)
├── middlewares/               # Express middleware (request logging, etc.)
└── loggers/                   # Log4js logger configuration

prisma/
└── schema.prisma              # Prisma schema for operations table

scripts/                       # Dev/smoke test scripts (if created)
```

### Responsibilities

- **Routes**: Define endpoints only. Call controllers. No DB access, no business logic.
- **Controllers**: Handle requests, validate inputs, compute results, call repositories. Never import Express objects in other layers.
- **Repositories**: DB access only. Expose clean API (insertOperation, listOperations, clearDatabase). No knowledge of HTTP.
- **Prisma Client**: Single instance in `src/db/clients/prisma.js`. Do NOT create PrismaClient in multiple files.

## Database Contracts

### PostgreSQL (Required)

**Database Name**: `operations`

**Table Name**: `operations`

**Schema**:
- `rawid` (integer): Unique, sequential ID starting at 1. NOT auto-increment in schema; managed by application.
- `flavor` (string): Either "STACK" or "INDEPENDENT" to distinguish operation type.
- `operation` (string): Operation name (e.g., "plus", "minus", "divide").
- `result` (integer): Computed result of the operation.
- `arguments` (string): JSON array of arguments as string (e.g., "[1,2,3]").

**Schema Rules**:
- Do NOT modify the tester's DB schema.
- If auto-increment is missing from the table, the app manages `rawid` itself.
- ALWAYS use the exact column names and types specified above.

### MongoDB

- MongoDB container is provided by instructor but may not run on Apple Silicon due to AVX/amd64-only constraints.
- Local development may use Postgres-only and validate Mongo behavior in an x86_64 environment if needed.
- MongoDB integration is optional for this assignment but container must be available for grading.

## Prisma Guidelines

### Single Client Instance

- **ALWAYS** import Prisma client from `src/db/clients/prisma.js`.
- **NEVER** create `new PrismaClient()` in any other file.

### ID Management & Concurrency

Since `rawid` is NOT auto-increment, the application manages it:

1. **Inside a Prisma transaction**: Compute next `rawid` using `getLast(tx, "rawid") + 1`.
2. **Guard concurrency**: Use Postgres advisory transaction lock (`pg_advisory_xact_lock`) if implementing high-concurrency ID generation.
3. **Transaction pattern**:
   ```javascript
   await prisma.$transaction(async (tx) => {
       const lastId = await getLast(tx, "rawid");
       const nextId = lastId ? lastId + 1 : 1;
       await tx.operation.create({ data: { rawid: nextId, ... } });
   });
   ```

### Repository Pattern

- Repository methods wrap Prisma calls.
- `insertOperation({ flavor, operation, result, arguments })`: Inserts with computed rawid.
- `listOperations(flavor)`: Queries operations, optionally filtered by flavor.
- `clearDatabase()`: Deletes all operations.

## API Behavior Rules

### STACK vs INDEPENDENT Persistence

Both operation flows MUST persist to the database symmetrically:

- **STACK operations**: Use `flavor: "STACK"` when inserting.
- **INDEPENDENT operations**: Use `flavor: "INDEPENDENT"` when inserting.

### Data Formatting

- **Always** store `arguments` as `JSON.stringify(args)` before inserting.
- Example: `arguments: JSON.stringify([1, 2, 3])` becomes `"[1,2,3]"` in DB.

### Endpoints

#### Stack Endpoints (`/calculator/stack`)
- `GET /stack/size` - Get current stack size
- `PUT /stack/arguments` - Push numbers onto stack
- `DELETE /stack/arguments?count=N` - Pop N numbers from stack
- `GET /stack/operate?operation=<op>` - Perform operation using stack arguments

#### Independent Endpoints (`/calculator/independent`)
- `POST /independent/calculate` - Perform calculation with provided arguments
  - Body: `{ "operation": "plus", "arguments": [1, 2] }`

#### General Endpoints
- `GET /calculator/health` - Health check
- `GET /calculator/history?flavor=<STACK|INDEPENDENT>` - Fetch history
- `DELETE /calculator/history` - Clear in-memory history
- `DELETE /calculator/database` - Clear database (Postgres operations table)

## Dev Workflows

### Setup & Installation

1. Clone the repository:
   ```bash
   git clone https://github.com/y0ncha/calculator-api.git
   cd calculator-api
   ```

2. Install dependencies:
   ```bash
   npm install
   ```

3. Set up environment variables (create `.env` if needed):
   ```bash
   DATABASE_URL="postgresql://<user>:<password>@localhost:5432/operations"
   ```

4. Generate Prisma client:
   ```bash
   npx prisma generate
   ```

### Running the Server

```bash
npm start
# or
node src/server.js
```

Server runs on port `8496` by default: `http://localhost:8496`

### Starting Docker Containers

#### Start Postgres & Mongo

```bash
docker-compose up -d
```

#### Notes:
- Postgres image: `theshultz/kaplat-calculator-postgres-instance:latest`
- Mongo image: `theshultz/kaplat-calculator-mongo-instance:latest`
- Both images use `platform: linux/amd64` (may require `--platform linux/amd64` on Apple Silicon).
- Postgres exposed on `5432`, Mongo on `27017`.

#### Apple Silicon Workaround

If Mongo fails to start due to AVX incompatibility:
```bash
# Start only Postgres
docker-compose up -d postgres
```

Local dev can proceed with Postgres-only. Test Mongo in x86_64 environment before submission.

### Inspecting the Database

#### Connect to Postgres container

```bash
docker exec -it <postgres-container-name> psql -U postgres -d operations
```

Replace `<postgres-container-name>` with your container name (default: `calculator-api-postgres-1` or similar).

#### Example queries

```sql
-- View all operations
SELECT * FROM operations ORDER BY rawid;

-- View only STACK operations
SELECT * FROM operations WHERE flavor = 'STACK' ORDER BY rawid;

-- View only INDEPENDENT operations
SELECT * FROM operations WHERE flavor = 'INDEPENDENT' ORDER BY rawid;

-- Count operations by flavor
SELECT flavor, COUNT(*) FROM operations GROUP BY flavor;

-- Check last rawid
SELECT MAX(rawid) FROM operations;
```

### Clearing the Database

Use the API endpoint:

```bash
DELETE http://localhost:8496/calculator/database
```

Or manually in Postgres:
```sql
DELETE FROM operations;
```

### Running Smoke Tests

If smoke tests exist in `scripts/`:
```bash
node scripts/smoke-test.js
# or
npm run smoke-test  # if script is defined in package.json
```

## Documentation & Style Rules

### Code Style

- **Module System**: CommonJS (`require`/`module.exports`). Do NOT use ES modules unless entire project is migrated.
- **Naming**: Follow existing conventions. Do not rename public endpoints or API contracts.
- **Separation of Concerns**: Controllers compute + orchestrate; repositories handle DB.

### JSDoc Comments

- Use JSDoc for module headers and function descriptions.
- Keep it brief and consistent with existing style (see `src/controllers/stack.js` for reference).
- Format:
  ```javascript
  /**
   * @module controllers/stack
   * @description Stack-based calculator logic
   */

  /**
   * @function stackCalculate
   * @description Performs operation using numbers from stack
   */
  ```

### Error Handling

- Return user-friendly error messages. Do NOT expose internal stack traces.
- Example: `"Error: unknown operation: xyz"` instead of raw exception details.
- Use status code `409` for validation/business logic errors.
- Use status code `200` for successful responses.

### Comments

- **Do NOT** add noisy comments explaining obvious code.
- **Do** explain intent and non-obvious logic.
- Keep comments minimal and purposeful.

## Common Pitfalls

1. **Multiple PrismaClient instances**: Always import from `src/db/clients/prisma.js`.
2. **Forgetting to persist operations**: Both STACK and INDEPENDENT operations MUST be persisted with correct flavor.
3. **Incorrect arguments format**: Always use `JSON.stringify(args)` before storing.
4. **rawid collisions**: Use transactions and consider advisory locks for high concurrency.
5. **Modifying schema**: Do NOT change the operations table schema provided by tester.

## Testing & Validation

### Manual Testing

1. Start server and containers.
2. Test stack operations:
   ```bash
   PUT /calculator/stack/arguments {"arguments": [5, 3]}
   GET /calculator/stack/operate?operation=plus
   ```
3. Test independent operations:
   ```bash
   POST /calculator/independent/calculate {"operation": "plus", "arguments": [10, 20]}
   ```
4. Verify persistence:
   ```bash
   # Check database manually or via query
   docker exec -it <postgres-container> psql -U postgres -d operations -c "SELECT * FROM operations;"
   ```

### Smoke Tests

Create smoke tests in `scripts/` to validate:
- Server starts and responds to health check
- Stack operations persist correctly
- Independent operations persist correctly
- Database clear endpoint works
- History endpoints return expected data

## Environment Variables

```bash
DATABASE_URL="postgresql://<user>:<password>@localhost:5432/operations"
# Replace <user> and <password> with your actual PostgreSQL credentials
# Add other environment variables as needed
```

## Summary

- Follow the layered architecture: routes -> controllers -> repositories.
- Use single Prisma client from `src/db/clients/prisma.js`.
- Persist EVERY operation with correct flavor (STACK or INDEPENDENT).
- Manage `rawid` in transactions using `getLast + 1` pattern.
- Keep documentation concise and consistent with existing JSDoc style.
- Test locally with Postgres; validate Mongo in x86_64 environment if needed.
